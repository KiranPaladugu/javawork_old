package com.marconi.tmp.tools;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.lang.reflect.Constructor;
import java.util.ArrayList;
import java.util.List;

import com.ericsson.oss.sbiadapter.converter.StepByStepConverter;
import com.ericsson.oss.sbiadapter.converter.StepByStepConverter.TypeOfConversion;
import com.ericsson.oss.slc.ClassConvertionException;
import com.marconi.fusion.X36.X36Message;
import com.marconi.fusion.X36.X36MessageFactory;
import com.marconi.fusion.base.application.Profile;
import com.marconi.fusion.base.asn1.msg.FileMsgBerReader;
import com.marconi.fusion.base.asn1.msg.Message;
import com.marconi.fusion.base.asn1.msg.MessageFactory;
import com.marconi.fusion.base.asn1.msg.io.MessageDecoder;
import com.marconi.fusion.base.logging.DumpInfo;
import com.marconi.fusion.tmf.i36PlugIn.I36PlugIn;
import com.marconi.fusion.tmf.plugIn.adapter.support.PENPDMConverter;

public class BERConverter {

	private Profile profile;
	private final String profileName = "I36Plugin.properties";
	int latestX36Index = 0;
	private StepByStepConverter stepByStepConverter;
	private String msgFactoryClsStr;

	public BERConverter() {
	}

	private String getBERVersion(final String berFile) {
		String version = null;
		if (berFile == null) {
			return version;
		}
		String name = berFile;
		try {

			int ind = name.lastIndexOf(".ber");
			if (ind != -1) {
				name = name.substring(0, ind);
				// removed extention.
				if ((name.lastIndexOf(".ber")) != -1) {
					return getBERVersion(name);
				}
				ind = name.lastIndexOf('_');
				int major = 0;
				int minor = 0;
				int sub = 0;
				try {
					if (ind != -1) {
						minor = Integer.parseInt(name.substring(ind + 1));
						name = name.substring(0, ind);
						ind = name.lastIndexOf('_');
						if (ind != -1) {
							sub = Integer.parseInt(name.substring(ind + 1));
							name = name.substring(0, ind);
							ind = name.lastIndexOf('_');
							if (ind != -1) {
								major = Integer.parseInt(name.substring(ind + 1));
							}
						}
					}
					if (major != 0 && minor != 0 && sub != 0) {
						version = major + "." + sub + "." + minor;
					}
				} catch (final Exception e) {
					major = 0;
					sub = 0;
					minor = 0;
					version = null;
				}
			}

		} catch (final Exception e) {
		}
		return version;
	}

	public void init(final String confPath, final String berLoc) {
		try {
			profile = new Profile(confPath + File.separator + profileName);
			latestX36Index = Integer.parseInt(profile.getProperty(I36PlugIn.PluginProperty.latestX36Index, "0"));
		} catch (final IOException e) {
			e.printStackTrace();
		}
		final File berFileLoc = new File(berLoc);
		if (berFileLoc.exists() && berFileLoc.isDirectory()) {
			final File berFiles[] = berFileLoc.listFiles();
			for (final File berFile : berFiles) {
				convert(berFile);
			}
		}
	}

	private void convert(final File berFile) {
		final String version = getVer(getBERVersion(berFile.getName()));
		boolean isLatestX36Version = true;
		final String syntaxSeperator = profile.getProperty(I36PlugIn.PluginProperty.x36SyntaxSeparator, "_");
		final int currentX36Index = Integer.parseInt(profile.getProperty("PlugIn.X36Index." + version, "0"));
		if (currentX36Index != latestX36Index) {
			isLatestX36Version = false;
			stepByStepConverter = new StepByStepConverter(latestX36Index, currentX36Index, syntaxSeperator, TypeOfConversion.X36,
					profile.getProperty(PENPDMConverter.ROOT_DIR));

			// Getting the MessageFactory according to the version of X36
			// Build the message factory class string
			msgFactoryClsStr = "com.marconi.fusion.X36" + syntaxSeperator + (currentX36Index - latestX36Index)
					+ ".X36MessageFactory";
		}

		List<X36Message<?>> x36MsgsList = new ArrayList<X36Message<?>>();
		try {
			x36MsgsList = getMessages(berFile, msgFactoryClsStr, isLatestX36Version);
		} catch (final Exception e) {
			e.printStackTrace();
		}
		System.out.println(x36MsgsList);
	}

	public List<X36Message<?>> getMessages(final File filename, final String msgFactoryClsStr, final boolean isLatestX36Version)
			throws Exception {

		System.out.println("Ready to read X36Messages from the BER files");

		final List<X36Message<?>> x36MsgList = new ArrayList<X36Message<?>>();
		MessageFactory<Message<?>> msgFactory = null;
		Constructor<?> berFileReaderConstructor = null;
		Object msgFactoryObj = null;
		final File berFile = null;

		try {
			if (msgFactoryClsStr != null && !isLatestX36Version) {

				// Load the message factory class
				final Class<?> msgFactoryClass = Class.forName(msgFactoryClsStr);

				// Create an instance of X36MessageFactory
				msgFactoryObj = msgFactoryClass.newInstance();

				// Load the FileMsgBerReader class
				final Class<?> berFileReaderClass = Class.forName("com.marconi.fusion.base.asn1.msg.FileMsgBerReader");

				// Get the constructor of FileMsgBerReader
				berFileReaderConstructor = berFileReaderClass.getConstructor(File.class, MessageDecoder.class);

			} else {
				msgFactory = new X36MessageFactory();
			}
			if (filename != null) {
				processBerFile(berFile, isLatestX36Version, berFileReaderConstructor, msgFactoryObj, msgFactory, x36MsgList);
			} else {
				System.err.println(new DumpInfo("Invalid BER location: "));
				throw new Exception("Invalid BER location : ");
			}
		} catch (final ClassNotFoundException e) {
			System.err.println(new DumpInfo("Unable to locate the class : " + msgFactoryClsStr, e));
			throw e;
		} catch (final InstantiationException e) {
			System.err.println(new DumpInfo("Unable to instantiate the class : " + msgFactoryClsStr, e));
			throw e;
		} catch (final FileNotFoundException e) {
			System.err.println(new DumpInfo("Unable to locate the BER file : " + berFile, e));
			throw e;
		} catch (final Exception e) {
			System.err.println(new DumpInfo("Unable to read messages from BER file", e));
			throw e;
		}
		return x36MsgList;
	}

	private void processBerFile(final File berFile, final boolean isLatestX36Version,
			final Constructor<?> berFileReaderConstructor, final Object msgFactoryObj,
			final MessageFactory<Message<?>> msgFactory, final List<X36Message<?>> x36MsgList) throws Exception {

		createBerForNeId(isLatestX36Version, berFileReaderConstructor, msgFactoryObj, berFile, msgFactory, x36MsgList);
	}

	@SuppressWarnings("unchecked")
	private void createBerForNeId(final boolean isLatestX36Version, final Constructor<?> berFileReaderConstructor,
			final Object msgFactoryObj, final File berFile, final MessageFactory<Message<?>> msgFactory,
			final List<X36Message<?>> x36MsgList) throws Exception {
		FileMsgBerReader<Message<?>> berReader = null;
		Message<?> msg = null;
		if (!isLatestX36Version) {
			// Build the message decoder class string
			final String messageDecoderClassStr = "com.marconi.fusion.base.asn1.msg.io.MessageDecoder";

			// Load the message decoder class
			final Class<?> messageDecoderClass = Class.forName(messageDecoderClassStr);

			// Get the constructor
			final Constructor<?> messageDecoderConstructor = messageDecoderClass.getConstructor(MessageFactory.class);

			final Object messageDecoderObject = messageDecoderConstructor.newInstance(msgFactoryObj);

			// Create instance of FileMsgBerReader
			final Object berFileReaderObject = berFileReaderConstructor.newInstance(berFile, messageDecoderObject);
			berReader = (FileMsgBerReader<Message<?>>) berFileReaderObject;

		} else {
			berReader = new FileMsgBerReader<Message<?>>(berFile, msgFactory);
		}
		// Read X36 messages from the ber file
		while ((msg = berReader.readBER()) != null) {
			// If the version of X36 message present in the ber file is not latest, convert it to latest
			// X36
			if (stepByStepConverter != null && !isLatestX36Version) {
				try {
					System.out
					.println(String.format("Converting <%s> which is read from the BER file", msg.getClass().getName()));
					msg = (Message<?>) stepByStepConverter.convert(msg, null);
				} catch (final ClassConvertionException c) {
					System.out.println(new DumpInfo("Unable to convert the class : " + msg.getClass().getName()
							+ " to the latest version", c));
				}
			}
			final X36Message<?> x36Msg = (X36Message<?>) msg;
			x36MsgList.add(x36Msg);
		}
		if (berReader != null) {
			berReader.close();
		}
	}

	private String getVer(final String version) {
		String ver = null;
		if (version != null) {
			version.replaceAll(".", "_");
			final int ind = version.lastIndexOf('_');
			if (ind != -1) {
				ver = version.substring(0, ind);
			}
		}
		return ver;
	}

	public static void main(final String args[]) {
		// args[0] -- Ber Location.
		if (args != null && args.length > 0) {

		} else {
			System.out.println("Arguments cannot be empty!");
		}
	}
}